<?php 
header('content-type:text/html;charset=utf-8');
date_default_timezone_set('PRC');
/**
 * create_file 							创建文件
 * @param  string 		$filemane		要创建的文件名
 * @return mixed 						true|失败信息
 */
function create_file(string $filename)
{
	// 检测文件是否存在
	if (is_file($filename)) {
		echo "文件已存在，不可重复创建";
		return false;
	}
	// 如果添加文件带路径，要判断文件夹是否存在，不存在则创建
	if (!is_dir(dirname($filename))) {
		// mkdir函数创建文件夹，0777是默认最大访问权限，true是允许添加子目录
		mkdir(dirname($filename),0777,true);
	}
	// 通过写入一个空字符串创建文件
	if (file_put_contents($filename,'')!==false) {
		return true;
	}else {
		echo "创建失败";
		return false;
	}
}
// create_file('a/3.txt');


/**
 * del_file 							删除文件
 * @param  string 		$filename 		删除的文件名
 * @return mixed 						true|失败信息
 */
function del_file(string $filename)
{
	// 检测文件是否存在
	if (!is_file($filename)) {
		echo "文件不存在";
		return false;
	}
	if (!is_writable($filename)) {
		echo "您没有删除权限";
		return false;
	}
	if (unlink($filename)) {
		return true;
	}else {
		echo "删除失败";
		return false;
	}
}
// del_file('a/3.txt');

/**
 * copy_file 								复制文件
 * @param  string 			$filename 		源文件名字
 * @param  string 			$dest 			要复制的目录，只写到目录名，不要上带文件名
 * @param  bool 			$dot 			默认false，当$dest需要创建时候文件名不能带点'.',目的判断填写的$dest是目录还是文件名，如果你非要创建带点的文件夹则输入true
 * @return mixed 							true|失败信息
 */
function copy_file(string $filename,string $dest,bool $dot=false)
{
	// 检测文件是否存在
	if (!is_file($filename)) {
		echo "文件不存在";
		return false;
	}
	// 检测要复制进的文件夹是否存在，不存在则创建
	if (!is_dir($dest)) {
		// mkdir($dest,0777,true);
		
		if ($dot) {
			// 如果你非要给文件名加上点
			mkdir($dest,0777,true);
		} else {
			// 这里默认是判断$dest中是否存在'.'，存在点就可能是个文件，而不是文件夹
			if (strpos(basename($dest),'.')) {
				echo "只输入要拷贝进的文件夹名字即可";
				return false;
			}else{
				mkdir($dest,0777,true);
			}
		}
	}
	// 新文件的路径
	$newName = $dest.DIRECTORY_SEPARATOR.basename($filename);
	// 判断$dest中是否存在同名文件
	if (is_file($newName)) {
		echo "该文件加内已有同名文件";
		return false;
	}
	if (copy($filename,$newName)) {
		return true;
	}else {
		echo "拷贝失败";
		return false;
	}
}
// create_file('3.txt');
// copy_file('a3.txt','a.a');


/**
 * rename_file 							重命名文件
 * @param  string 		$oldName 		旧名字
 * @param  string 		$newName 		新名字
 * @return mixed 						true|失败信息
 */
function rename_file(string $oldName,string $newName)
{
	// 检测文件是否存在
	if (!is_file($oldName)) {
		echo "要重命名的文件不存在";
		return false;
	}
	// 定义newName的路径，这样重命名时候新名字不用写目录了
	$dataName = dirname($oldName).DIRECTORY_SEPARATOR.$newName;
	// 检测改后文件是否与已存在文件重名
	if (file_exists($dataName)) {
		echo "改后文件与已有文件重名";
		return false;
	}
	if (rename($oldName,$dataName)) {
		return true;
	}else {
		echo "重命名失败";
		return false;
	}
}
// rename_file('1.txt','4.txt');
// $dataName = dirname('a/1.txt').DIRECTORY_SEPARATOR.'2.txt';
// echo $dataName;


/**
 * cut_file 							剪切文件
 * @param  string 		$filename 		原文件
 * @param  string 		$data 	 		剪切目录
 * @param  bool 		$dot 			默认false，当$ddata需要创建时候文件名不能带点'.',目的判断填写的$dest是目录还是文件名，如果你非要创建带点的文件夹则输入true
 * @return mixed 						true|失败信息
 */
function cut_file(string $filename,string $data,bool $dot=false)
{
	// 检测文件是否存在
	if (!is_file($filename)) {
		echo "要剪切的文件不存在";
		return false;
	}
	// 要判断剪切的目录是否存在，不存在则创建
	if (!is_dir($data)) {
		if ($dot) {
			// 如果你非要给文件名加上点
			mkdir($data,0777,true);
		} else {
			// 这里默认是判断$data中是否存在'.'，存在点就可能是个文件，而不是文件夹
			if (strpos(basename($data),'.')) {
				echo "只输入要剪切进的文件夹名字即可";
				return false;
			}else{
				mkdir($data,0777,true);
			}
		}
	}
	// 定义新文件的路径
	$dataName = $data.DIRECTORY_SEPARATOR.basename($filename);
	if (is_file($dataName)) {
		echo "剪切路径下已有重名文件";
		return false;
	}
	if (rename($filename,$dataName)) {
		return true;
	}else {
		echo "剪切失败";
		return false;
	}
}
// create_file('1.txt');
// cut_file('a.txt','b.b',true);


/**
 * get_file_info 						读取文件信息
 * @param  string 		$filename 		文件名
 * @return mixed 						数组|失败原因
 */
function get_file_info(string $filename)
{
	// 检测文件是否存在
	if (!is_file($filename)) {
		echo "要查看的文件不存在";
		return false;
	}
	if (!is_readable($filename)) {
		echo "您没有权限读取该文件";
		return false;
	}
	$infoName = array(
		'文件名' => basename($filename),
		'文件路径' => dirname($filename),
		'上次访问时间' => date("Y-m-d H:i:s",fileatime($filename)),
		'修改时间' => date("Y-m-d H:i:s",filemtime($filename)),
		'inode修改时间' => date("Y-m-d H:i:s",filectime($filename)),
		'inode' => fileinode($filename),
		'文件大小' => trans_byte(filesize($filename)),
		'文件类型' => filetype($filename)
	 );
	return $infoName;
}
// print_r(get_file_info('1.txt'));

/**
 * 
 * trans_byte					 	字节单位转换的函数
 * @param  int        $byte      	字节
 * @param  integer    $precision 	默认精度，保留小数点后2位
 * @return string                	转换之后的字符串
 */
function trans_byte(int $byte,int $precision=2)
{
	$kb = 1024;
	$mb = 1024*$kb;
	$gb = 1024*$mb;
	$tb = 1024*$gb;
	if ($byte<$kb) {
		return $byte.'B';
	}elseif ($byte<$mb) {
		return round($byte/$kb,$precision).'KB';
	}elseif ($byte<$gb) {
		return round($byte/$mb,$precision).'MB';
	}elseif ($byte<$tb) {
		return round($byte/$gb,$precision).'GB';
	}else {
		return round($byte/$tb,$precision).'TB';
	}
}


/**
 * read_file 							读取文件内容到字符串
 * @param  string 		$filename 		文件名
 * @param  bool 		$tag 			是否过滤HTML标记，默认不过滤
 * @return string 						文件内容|失败原因
 */
function read_file(string $filename,bool $tag=false)
{
	// 检测文件
	if (!is_file($filename)) {
		echo "要读取的文件不存在";
		return false;
	}
	if (!is_readable($filename)) {
		echo "您没有权限读取该文件";
		return false;
	}
	if ($tag) {
		return strip_tags(file_get_contents($filename));
	} else {
		return file_get_contents($filename);
	}
}
// echo read_file('a3.txt',true);


/**
 * read_file_array 						读取文件内容到数组
 * @param  string 		$filename 		文件名字
 * @param  bool 		$blankLine 		是否过滤空行，默认不过滤
 * @param  bool 		$tag 			是否过滤HTML标记，默认不过滤
 * @return miexd 						数组|是不原因
 */
function read_file_array(string $filename,bool $blankLine=false,bool $tag=false)
{
	// 检测文件
	if (!is_file($filename)) {
		echo "要读取的文件不存在";
		return false;
	}
	if (!is_readable($filename)) {
		echo "您没有权限读取该文件";
		return false;
	}
	if ($blankLine) {
		$arrRead = file($filename,FILE_IGNORE_NEW_LINES|FILE_SKIP_EMPTY_LINES);
	} else {
		$arrRead = file($filename);
	}
	if ($tag) {
		$arrRead2 = [];
		foreach ($arrRead as $value) {
			$v = strip_tags($value);
			array_push($arrRead2,$v);
		}
		return $arrRead2;
	}
	return $arrRead;
	
	
	
}
// print_r(read_file_array('1.txt',true));



/**
 * @param  string 		文件名
 * @param  mixed 		要写入的信息
 * @param  bool 		是否清楚原来文件里的信息，默认不清楚往后写入
 * @return mixed 		写入到文件内数据的字节数，失败时返回FALSE 
 */
function write_file(string $filename,$data,bool $cover=true)
{
	// 检测要写入的文件存不存在，不存在创建目录，一会写入时候回自动创建文件名
	$dirName = dirname($filename);
	if(!is_dir($dirName)){
		mkdir($dirName,0777,true);
	}
	// 如果添加内容是数组或者对象，就转换成一个可存储的值的表示 
	if (is_array($data)||is_object($data)) {
		$data = serialize($data);
	}
	// 是否保存原内容，默认保存，则读取原内容，新内容拼在后面然后写入
	if ($cover) {
		// 这里要确认原文件存在才能读取
		if (is_file($filename)) {
			$content = file_get_contents($filename);
			$data = $content.$data;
		}
		return file_put_contents($filename,$data);
	} else {
		return file_put_contents($filename,$data);
	}
	
	
}
// $a = ['a','b','c'];
// write_file('4.txt',$a);



/**
 * 
 * truncate_file 						截断文件到指定大小
 * @param  string        $filename 		文件名
 * @param  int           $length   		长度
 * @return boolean                 		true|false
 */
function truncate_file(string $filename,int $length){
  //检测是否是文件
  if(is_file($filename)&&is_writable($filename)){
    $handle=fopen($filename,'r+');
    // 检测输入长度是否为正数
    $length=$length<0?0:$length;
    ftruncate($handle,$length);
    fclose($handle);
    return true;
  }else{
  	return false;
  }
}
// truncate_file('4.txt',5);



/**
 * 使用时候用a标签get传值就可以了
 * down_file 							下载文件
 * @param  string    $filename     		文件名
 * @param  array     $allowDownExt 		允许下载的文件类型
 * @return void
 */
function down_file(string $filename,array $allowDownExt=array('jpeg','jpg','png','gif','txt','html','php','rar','zip'))
{
  //检测下载文件是否存在，并且可读
  if(!is_file($filename)||!is_readable($filename)){
  	echo "要下载的文件不存在或者没有下载的权限";
    return false;
  }
  //检测文件类型是否允许下载
  $ext=strtolower(pathinfo($filename,PATHINFO_EXTENSION));
  if(!in_array($ext,$allowDownExt)){
  	echo "你不能下载该后缀的文件";
    return false;
  }
  //通过header()发送头信息

  //告诉浏览器输出的是字节流
  header('Content-Type:application/octet-stream');

  //告诉浏览器返回的文件大小是按照字节进行计算的
  header('Accept-Ranges: bytes');

  $filesize=filesize($filename);
  //告诉浏览器返回的文件大小
  header('Accept-Length: '.$filesize);

  //告诉浏览器文件作为附件处理，告诉浏览器最终下载完的文件名称
  header('Content-Disposition: attachment;filename='.basename($filename));

  //读取文件中的内容

  //规定每次读取文件的字节数为1024字节，直接输出数据
  $read_buffer=1024;
  $sum_buffer=0;
  $handle=fopen($filename,'rb');
  while(!feof($handle) && $sum_buffer<$filesize){
    echo fread($handle,$read_buffer);
    $sum_buffer+=$read_buffer;
  }
  fclose($handle);
  exit;
}




// 定义错误常量,是给下面上传文件定义的，防止多个文件上传走循环时候显示重复定义变量
define('UPLOAD_ERRS',array(
		"UPLOAD_ERR_OK"         =>"没有发生错误，文件上传成功",
		"UPLOAD_ERR_INI_SIZE"   =>"上传的文件超过了php.ini中upload_max_filesize（默认情况为2M）选项限制的值",
		"UPLOAD_ERR_FORM_SIZE"  =>"上传文件的大小超过了HTML标点中MAX_FILE_SIZE选项的值",
		"UPLOAD_ERR_PARTIAL"    =>"文件只有部分被上传",
		"UPLOAD_ERR_NO_FILE"    =>"没有文件被上传",
		"UPLOAD_ERR_NO_TMP_DIR" =>"找不到临时文件",
		"UPLOAD_ERR_CANT_WRITE" =>"文件写入失败",
		"UPLOAD_ERR_EXTENSION"  =>"上传的文件被PHP扩展程序中断",
		//上面是$_FILES带的error参数错误结果，下面写我自定义的
		"FILE_TYPE_NOT_CONFORMING"=>"上传文件类型不符合规定",
		"FILE_CORRUPTED"=>"请上传一张真实的图片",
		"FILE_SIZE_VIOLATION"=>"您上传的文件超过规定大小",
		"UPLOAD_FILE_VIA_HTTP_POST"=>"请通过HTTP POST上传文件",
		"FILE_NOVE_FAILED"=>"文件移动失败"
	));
/**
 * upload_file
 * @param 	array 		$fileInfo 		通过_FILES接收的数组
 * @param 	array 		$allowExt 		规定可以上传的文件名
 * @param 	bool 		$imageFlag 		是否检测上传文件为真实图片
 * @param 	int 		$maxSize 		最大上传文件大小
 * @param 	string 		$uploadPath 	上传文件存储位置
 * @return 	string 						错误信息|上传文件存储位置的路径
 * 上传文件表单属性应添加enctype="multipart/form-data"
 */
function upload_file(array $fileInfo,array $allowExt=['jpg','png','jpeg','gif'],bool $imageFlag=false,int $maxSize=2097152,string $uploadPath='./uploads')
{
	
	

	// 读取fileInfo的数据
	$name     = $fileInfo['name'];
	$type     = $fileInfo['type'];
	$tmp_name = $fileInfo['tmp_name'];
	$error    = $fileInfo['error'];
	$size     = $fileInfo['size'];

	// 判断错误类型
	if ($error!==0) {
		switch ($error) {
			case 1:
				$msg = UPLOAD_ERRS['UPLOAD_ERR_INI_SIZE'];
				break;
			case 2:
				$msg = UPLOAD_ERRS['UPLOAD_ERR_FORM_SIZE'];
				break;
			case 3:
				$msg = UPLOAD_ERRS['UPLOAD_ERR_PARTIAL'];
				break;
			case 4:
				$msg = UPLOAD_ERRS['UPLOAD_ERR_NO_FILE'];
				break;
			case 6:
				$msg = UPLOAD_ERRS['UPLOAD_ERR_NO_TMP_DIR'];
				break;
			case 7:
				$msg = UPLOAD_ERRS['UPLOAD_ERR_CANT_WRITE'];
				break;
			case 8:
				$msg = UPLOAD_ERRS['UPLOAD_ERR_EXTENSION'];
				break;
		}
		echo $msg;
		return false;
	}

	// 获取上传的文件的后缀，判断后缀是否符合规定
	$ext = strtolower(pathinfo($name,PATHINFO_EXTENSION));
	if (!in_array($ext, $allowExt)) {
		echo UPLOAD_ERRS['FILE_TYPE_NOT_CONFORMING'];
		return false;
	}

	// 判断是否为一张真实的图片，因为仅在上传图片时使用所以加一个参数,默认是不判断的
	if ($imageFlag) {
		if (@!getimagesize($tmp_name)) {
			echo UPLOAD_ERRS['FILE_CORRUPTED'];
			return false;
		}
	}
	
	// 判断上传文件的大小是否符合规定
	if ($size>$maxSize) {
		echo UPLOAD_ERRS['FILE_SIZE_VIOLATION'];
		return false;
	}

	// 判断文件是不是通过HTTP POST上传的
	if (!is_uploaded_file($tmp_name)) {
		echo UPLOAD_ERRS['UPLOAD_FILE_VIA_HTTP_POST'];
		return false;
	}

	// 如果存放上传路径的文件夹不存在就创建一个
	if (!is_dir($uploadPath)) {
		mkdir($uploadPath,0777,true);
	}

	// 生产唯一文件名
	$newName = pathinfo($name)['filename'];
	$uniqidName = $newName.'_'.uniqid();
	// 给文件名加上路径
	$dest = $uploadPath.DIRECTORY_SEPARATOR.$uniqidName.'.'.$ext;
	// 移动临时文件到指定的存储位置
	if (@!move_uploaded_file($tmp_name, $dest)) {
		echo UPLOAD_ERRS['FILE_NOVE_FAILED'];
		return false;
	}else{
		echo "文件上传成功";
		return $dest;
	}

}



/**
 * upload_multiple_files 			多文件上传
 * @param  array 	$filearray 		多文件上传通过_FILES获得的数组
 * @return array 					upload_file函数的结果
 */
function upload_multiple_files(array $filearray)
{
	foreach ($filearray['name'] as $key => $value) {
	 	$fileInfo[$key]['name']=$filearray['name'][$key];
	 	$fileInfo[$key]['type']=$filearray['type'][$key];
	 	$fileInfo[$key]['tmp_name']=$filearray['tmp_name'][$key];
	 	$fileInfo[$key]['error']=$filearray['error'][$key];
	 	$fileInfo[$key]['size']=$filearray['size'][$key];
	} 
	foreach ($fileInfo as $key => $value) {
		upload_file($value,['doc']);
		echo '<br>';
	}
}




/**
 * 压缩单个文件
 * @method zip_file
 * @param  string   $filename 文件名
 * @return boolean             true|false
 */
function zip_file(string $filename){
  if(!is_file($filename)){
    return false;
  }
  $zip=new ZipArchive();
  $zipName=basename($filename).'.zip';
  //打开指定压缩包，不存在则创建，存在则覆盖
  if($zip->open($zipName,ZipArchive::CREATE|ZipArchive::OVERWRITE)){
    //将文件添加到压缩包中
    if($zip->addFile($filename)){
      $zip->close();
      @unlink($filename);
      return true;
    }else{
      return false;
    }
  }else{
    return false;
  }
}
// zip_file('dome.php');



/**
 * 多文件压缩
 * @method zip_files
 * @param  string    $zipName 压缩包的名称，.zip结尾
 * @param  string     $files   需要压缩文件名，可以是多个
 * @return boolean             true|false
 */
/*
function zip_files(string $zipName,...$files){
  //检测压缩包名称是否正确
  $zipExt=strtolower(pathinfo($zipName,PATHINFO_EXTENSION));
  // if('zip'!==$zipExt){
  // 	echo "1";
  //   return false;
  // }
  $zip=new ZipArchive();
  if($zip->open($zipName,ZipArchive::CREATE|ZipArchive::OVERWRITE)){
    foreach($files as $file){
      if(is_file($file)){
        $zip->addFile($file);
      }
    }
    $zip->close();
    return true;
  }else{
    return false;
  }
}
var_dump(zip_files('upload.html','dome.php'));
*/



/**
 * 解压缩
 * @method unzip_file
 * @param  string     $zipName 压缩包名称
 * @param  string     $dest    解压到指定目录
 * @return boolean              true|false
 */
/*
function unzip_file(string $zipName,string $dest){
  //检测要解压压缩包是否存在
  if(!is_file($zipName)){
    return false;
  }
  //检测目标路径是否存在
  if(!is_dir($dest)){
    mkdir($dest,0777,true);
  }
  $zip=new ZipArchive();
  if($zip->open($zipName)){
    $zip->extractTo($dest);
    $zip->close();
    return true;
  }else{
    return false;
  }
}
var_dump(unzip_file('zhaochen.com.zip','a'));
*/
